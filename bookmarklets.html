<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Projector Bookmarklets</title>

    <script id="projectChordsFunction">
        function projectChords(action) {
            if (action === 'return_chord_projector_url') {
                return constructChordProjectorUrl();
            }

            const {text, title, artist} = extractContent() ?? {};

            switch(action) {
                case 'copy_chords':
                    copyToClipboard(text);
                    break;

                case 'open_projector':
                    openWindow(constructChordProjectorUrl(text, title, artist));
                    break;

                case 'open_projector_in_place':
                    openHere(constructChordProjectorUrl(text, title, artist));
                    break;

                case 'offer_for_projection':
                    if (text) {
                        openWindow(constructOpenerUrl(text, title, artist));
                    } else {
                        alert("Could not find text on the page to cast.");
                    }
                    break;

               default:
                    console.error('Invalid action', action);
            }

            function extractContent() {
                const mappers = {
                    'ultimate-guitar.com': extractUltimateGuitarContent,
                    '2akordi.net': extract2AkordiNetContent,
                    'pesmarica.rs': extractPesmaricaContent,
                };

                for (const [url, mapper] of Object.entries(mappers)) {
                    if (location.hostname === url || location.hostname?.endsWith('.' + url)) {
                        return mapper();
                    }
                }

                return undefined;
            }

            function extractUltimateGuitarContent() {
                const text = queryText('section code pre');
                const title = queryText('main h1');
                const artist = title.startsWith("Official ") ? queryText('main h1 + span') : queryText('main h1 + span + span');
                return {
                    text,
                    title: title.replace(/ Chords( & Tabs)?$/, '').replace(/^Official /, ''),
                    artist
                };
            }

            function extract2AkordiNetContent() {
                const text = queryText('#container pre');
                const fullName = queryText('.header h3');
                const [artist, title] = split(fullName, "::", " - ");
                return {
                    text,
                    title: artist && title ? title : fullName,
                    artist: artist && title ? artist : ''
                }
            }

            function extractPesmaricaContent() {
                return {
                    text: queryText('main pre'),
                    title: queryText('main h1'),
                    artist: queryText('main h2')
                }
            }

            function constructOpenerUrl(text, title, artist) {
                const url = constructBaseUrl() +  '/opener.html';
                return appendParams(url, text, title, artist);
            }

            function constructChordProjectorUrl(text, title, artist) {
                const url = constructBaseUrl() +  '/chord_projector.html';
                return text ? appendParams(url, text, title, artist) : url;
            }

            function constructBaseUrl() {
                try {
                    const override = window.localStorage?.getItem('chordProjector.baseUrlOverride');
                    if (override) {
                        return override;
                    }
                } catch {
                }

                return 'https://brunoalfirevic.github.io/ChordProjector';
            }

            function appendParams(url, text, title, artist) {
                return url + (text ? '#text=' + encodeURIComponent(text) : '') +
                             (title ? '&title=' + encodeURIComponent(title) : '') +
                             (artist ? '&artist=' + encodeURIComponent(artist) : '');
            }

            function openWindow(url) {
                const openedWindow = window.open(url, '_blank', 'noopener');
            }

            function openHere(url) {
                location.href = url;
            }

            function queryText(selector) {
                const element = document.querySelector(selector);

                if (!element) {
                    console.warn('Element not found with selector:', selector);
                }

                return element?.textContent?.trim() ?? '';
            }

            function split(text, ...splitters) {
                for (const splitter of splitters) {
                    if (text.includes(splitter)) {
                        return text.split(splitter).map(v => v.trim());
                    }
                }

                return [text];
            }

            function copyToClipboard(text) {
                if (!text) {
                    return;
                }

                /* Try to use the Clipboard API first (modern browsers) */
                if (navigator.clipboard) {
                    return navigator.clipboard.writeText(text)
                        .then(() => {
                            console.log('Text copied to clipboard');
                            return true;
                        })
                        .catch(err => {
                            console.error('Clipboard API failed:', err);
                            /* Try fallback method */
                            return fallbackCopy(text);
                        });
                } else {
                    /* Use fallback for browsers without Clipboard API */
                    return Promise.resolve(fallbackCopy(text));
                }

                function fallbackCopy(text) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;

                    /* Make it invisible */
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    textarea.style.top = '0';
                    textarea.setAttribute('readonly', ''); /* Prevent mobile keyboards */

                    document.body.appendChild(textarea);

                    /* Special handling for iOS */
                    const isIOS = navigator.userAgent.match(/ipad|iphone/i);

                    if (isIOS) {
                        const range = document.createRange();
                        range.selectNodeContents(textarea);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        textarea.setSelectionRange(0, 999999); /* For mobile devices */
                    } else {
                        textarea.select();
                    }

                    let success = false;
                    try {
                        success = document.execCommand('copy');
                    } catch (err) {
                        console.error('Clipboard Copy Fallback: Could not copy text: ', err);
                    }

                    /* Clean up */
                    document.body.removeChild(textarea);
                    return success;
                }
            }
        }
    </script>
</head>
<body>
    <script>
        function createLink(href, text) {
            const link = document.createElement('a');
            link.href = href;
            link.innerText = text;
            return link;
        }

        function createBookmarklet(title, action) {
            const functionSource = projectChords.toString();
            const href = 'javascript:' + encodeURI('(' + functionSource + ')("' + action +'")');
            return createLink(href, title);
        }

        function append(element) {
            if (element) {
                document.body.appendChild(element);
            }
            document.body.appendChild(document.createElement('br'));
        }

        append(createBookmarklet('Copy chords to clipboard', 'copy_chords'));
        append();
        append(createBookmarklet('Show in Chord Projector', 'open_projector'));
        append(createBookmarklet('Show in Chord Projector (stay in same tab)', 'open_projector_in_place'));
        append();
        append(createBookmarklet('Cast chords directly', 'offer_for_projection'));
        append();
        append(createLink(projectChords('return_chord_projector_url'), 'Open blank Chord Projector'));
    </script>
</body>
